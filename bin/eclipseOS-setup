#!/usr/bin/env bash
set -euo pipefail

echo "=== Installing eclipseOS extra packages ==="
echo

AUR_PACKAGES=(
  python-pyautogui
  vesktop
  clipse
  zen-browser-bin
  visual-studio-code-bin
  spicetify-themes
  github-desktop-bin
)

# -------------------------------------------------------------------
# System update
# -------------------------------------------------------------------
sudo pacman -Syu --noconfirm

# -------------------------------------------------------------------
# Ensure yay exists
# -------------------------------------------------------------------
if ! command -v yay >/dev/null 2>&1; then
  echo "-> Installing yay..."
  sudo pacman -S --needed --noconfirm git base-devel
  git clone https://aur.archlinux.org/yay.git /tmp/yay
  pushd /tmp/yay >/dev/null
  makepkg -si --noconfirm
  popd >/dev/null
fi

yay -Syu --noconfirm

# -------------------------------------------------------------------
# Install AUR packages
# -------------------------------------------------------------------
FAILED_PACKAGES=()

for package in "${AUR_PACKAGES[@]}"; do
  echo "-> Clean-building $package..."
  if ! yay -S --noconfirm --rebuild --cleanafter "$package"; then
    echo "!! Failed to install $package"
    FAILED_PACKAGES+=("$package")
  fi
done

# -------------------------------------------------------------------
# Spicetify setup
# -------------------------------------------------------------------
echo
echo "=== Configuring Spicetify ==="

SPOTIFY_PREFS="$HOME/.config/spotify/prefs"
SPOTIFY_INSTALL="/opt/spotify"

if [[ ! -f "$SPOTIFY_PREFS" ]]; then
  echo "-> Spotify prefs not found, creating fake prefs..."
  mkdir -p "$(dirname "$SPOTIFY_PREFS")"
  touch "$SPOTIFY_PREFS"
fi

if [[ -d "$SPOTIFY_INSTALL" ]]; then
  echo "-> Adjusting permissions for /opt/spotify..."
  sudo chown -R "$USER:$USER" "$SPOTIFY_INSTALL"
fi

spicetify backup apply
curl -fsSL https://raw.githubusercontent.com/spicetify/spicetify-marketplace/main/resources/install.sh | sh
spicetify update
spicetify apply

# -------------------------------------------------------------------
# Permissions
# -------------------------------------------------------------------
echo
echo "=== Configuring File Permissions ==="

chmod +x .config/waybar/scripts/* 2>/dev/null || true
chmod +x .config/rofi/* 2>/dev/null || true

# -------------------------------------------------------------------
# Fish shell
# -------------------------------------------------------------------
echo
echo "=== Configuring Fish as shell ==="

if command -v fish >/dev/null 2>&1; then
  if ! grep -Fxq "$(command -v fish)" /etc/shells; then
    command -v fish | sudo tee -a /etc/shells >/dev/null
  fi
  sudo chsh -s "$(command -v fish)" "$USER"
fi

# -------------------------------------------------------------------
# WhatsApp Altus
# -------------------------------------------------------------------
echo
echo "=== Installing WhatsApp Altus ==="

WHATSAPP_DIR="$HOME/Documents/Apps/Whatsapp"
WHATSAPP_APPIMAGE="$WHATSAPP_DIR/whatsapp.AppImage"

mkdir -p "$WHATSAPP_DIR"

curl -L "$(
  curl -s https://api.github.com/repos/amanharwara/altus/releases/latest \
    | grep browser_download_url \
    | grep AppImage \
    | cut -d '"' -f 4
)" -o "$WHATSAPP_APPIMAGE"

chmod +x "$WHATSAPP_APPIMAGE"

sudo tee /usr/share/applications/whatsapp.desktop >/dev/null <<EOF
[Desktop Entry]
Type=Application
Name=WhatsApp
Exec=$WHATSAPP_APPIMAGE
Terminal=false
Categories=Network;InstantMessaging;
EOF

echo "✔ WhatsApp Altus installed!"

# -------------------------------------------------------------------
# Package summary
# -------------------------------------------------------------------
echo
echo "=== Package summary ==="

if (( ${#FAILED_PACKAGES[@]} > 0 )); then
  echo "⚠ Failed packages:"
  for pkg in "${FAILED_PACKAGES[@]}"; do
    echo " - $pkg"
  done
else
  echo "✓ All packages installed successfully!"
fi

# -------------------------------------------------------------------
# Swap & ZRAM
# -------------------------------------------------------------------
echo
echo "=== Setting up proper swap ==="
echo

TOTAL_RAM_MIB=$(awk '/MemTotal/ {print int($2/1024)}' /proc/meminfo)
HALF_RAM_MIB=$((TOTAL_RAM_MIB / 2))

echo "Total RAM: $TOTAL_RAM_MIB MiB"
echo "ZRAM:      $HALF_RAM_MIB MiB"
echo "Swapfile:  $HALF_RAM_MIB MiB"

# Disable existing zram
while read -r dev; do
  sudo swapoff "$dev"
done < <(swapon --show=NAME --noheadings | grep '^/dev/zram' || true)

sudo rm -f /etc/systemd/zram-generator.conf

sudo tee /etc/systemd/zram-generator.conf >/dev/null <<EOF
[zram0]
zram-size = ${HALF_RAM_MIB}MiB
compression-algorithm = lz4
swap-priority = 100
EOF

SWAPFILE=/swapfile

if swapon --show=NAME --noheadings | grep -qx "$SWAPFILE"; then
  sudo swapoff "$SWAPFILE"
fi

sudo sed -i "\|^$SWAPFILE |d" /etc/fstab
sudo rm -f "$SWAPFILE"
sudo truncate -s "${HALF_RAM_MIB}M" "$SWAPFILE"
sudo chmod 600 "$SWAPFILE"
sudo mkswap "$SWAPFILE"
sudo swapon -p 10 "$SWAPFILE"

echo "$SWAPFILE none swap defaults,pri=10 0 0" | sudo tee -a /etc/fstab >/dev/null

sudo systemctl daemon-reload
sudo systemctl restart systemd-zram-setup@zram0.service

echo
swapon --show
echo "Swap set up!"

# -------------------------------------------------------------------
# Reboot
# -------------------------------------------------------------------
echo
echo "Rebooting in 5 seconds..."
sleep 5
sudo reboot
