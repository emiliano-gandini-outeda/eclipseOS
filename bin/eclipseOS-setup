#!/bin/bash

echo "=== Installing eclipseOS extra packages ==="
echo

AUR_PACKAGES=(
  "python-pyautogui"
  "vesktop"
  "clipse"
  "zen-browser-bin"
  "visual-studio-code-bin"
  "spicetify-themes"
  "github-desktop-bin"
)

sudo pacman -Syu --noconfirm

# Ensure yay exists
if ! command -v yay &> /dev/null; then
  echo "-> Installing yay..."
  sudo pacman -S --needed --noconfirm git base-devel
  git clone https://aur.archlinux.org/yay.git /tmp/yay
  cd /tmp/yay
  makepkg -si --noconfirm
  cd - >/dev/null
fi

yay -Syu --noconfirm

FAILED_PACKAGES=()

for package in "${AUR_PACKAGES[@]}"; do
  echo "-> Clean-building $package..."
  if ! yay -S \
    --noconfirm \
    --cleanbuild \
    --rebuild \
    --cleanafter \
    "$package"; then
    echo "!! Failed to install $package"
    FAILED_PACKAGES+=("$package")
  fi
done

echo
echo "=== Configuring Spicetify ==="

SPOTIFY_PREFS="$HOME/.config/spotify/prefs"
SPOTIFY_INSTALL="/opt/spotify"

if [ ! -f "$SPOTIFY_PREFS" ]; then
  echo "-> Spotify prefs not found, creating a fake prefs..."
  mkdir -p "$(dirname "$SPOTIFY_PREFS")"
  touch "$SPOTIFY_PREFS"
fi

if [ -d "$SPOTIFY_INSTALL" ]; then
  echo "-> Adjusting permissions for /opt/spotify..."
  sudo chown -R "$USER:$USER" "$SPOTIFY_INSTALL"
fi

spicetify backup apply
curl -fsSL https://raw.githubusercontent.com/spicetify/spicetify-marketplace/main/resources/install.sh | sh
spicetify update
spicetify apply


echo "=== Configuring File Permissions ==="
chmod +x .config/waybar/scripts/*

echo "=== Configuring Fish as shell ==="

# Set fish as default shell (only if installed)
if command -v fish >/dev/null 2>&1; then
    # Ensure fish is in /etc/shells
    if ! grep -Fxq "$(command -v fish)" /etc/shells; then
        echo "$(command -v fish)" | sudo tee -a /etc/shells >/dev/null
    fi

    # Change the default shell for the user running the installer
    sudo chsh -s "$(command -v fish)" "$USER"
fi

echo "=== Installing Whatsapp Altus ==="

# Crear directorio de la app
mkdir -p ~/Documents/Apps/Whatsapp

# Descargar AppImage de WhatsApp

curl -L \
$(curl -s https://api.github.com/repos/amanharwara/altus/releases/latest \
 | grep browser_download_url \
 | grep AppImage \
 | cut -d '"' -f 4) \
-o ~/Documents/Apps/Whatsapp/whatsapp.AppImage


# Dar permisos de ejecución
chmod +x ~/Documents/Apps/Whatsapp/whatsapp.AppImage

# Crear archivo .desktop del sistema
sudo tee /usr/share/applications/whatsapp.desktop > /dev/null <<EOF
[Desktop Entry]
Type=Application
Name=WhatsApp
Exec=$HOME/Documents/Apps/Whatsapp/whatsapp.AppImage
Terminal=false
Categories=Network;InstantMessaging;
EOF

echo "✔ Done! Whatsapp Altus installed !"

echo
echo "✔ Done! All eclipseOS packages processed."

if [ ${#FAILED_PACKAGES[@]} -gt 0 ]; then
  echo
  echo "⚠ The following packages failed to install:"
  for pkg in "${FAILED_PACKAGES[@]}"; do
    echo " - $pkg"
  done
else
  echo "✓ All packages installed successfully!"
fi

echo "=== Setting up proper swap ==="

# Setup ZRAM (50% RAM) + SSD swapfile (50% RAM) using zram-generator
# All sizes expressed in MiB (no suffix)

# Get total RAM in MiB
TOTAL_RAM=$(awk '/MemTotal/ {print int($2/1024)}' /proc/meminfo)
HALF_RAM=$((TOTAL_RAM / 2))

# ---- Remove existing zram swaps ----
for dev in $(swapon --show=NAME --noheadings | grep zram); do
  sudo swapoff "$dev"
done

sudo rm -f /etc/systemd/zram-generator.conf

# ---- Configure zram-generator ----
sudo tee /etc/systemd/zram-generator.conf >/dev/null <<EOF
[zram0]
zram-size = $HALF_RAM
compression-algorithm = lz4
swap-priority = 100
EOF

# ---- SSD swapfile ----
SWAPFILE=/swapfile

# Disable existing swapfile
if swapon --show=NAME --noheadings | grep -q "$SWAPFILE"; then
  sudo swapoff "$SWAPFILE"
fi

# Recreate swapfile
sudo rm -f "$SWAPFILE"
sudo fallocate -l "$HALF_RAM"M "$SWAPFILE"
sudo chmod 600 "$SWAPFILE"
sudo mkswap "$SWAPFILE"
sudo swapon -p 10 "$SWAPFILE"

# Persist swapfile
if ! grep -q "^$SWAPFILE" /etc/fstab; then
  echo "$SWAPFILE none swap defaults,pri=10 0 0" | sudo tee -a /etc/fstab
fi

# ---- Reload zram ----
sudo systemctl daemon-reload
sudo systemctl restart systemd-zram-setup@zram0.service

echo "Swap set up!"

echo "Time to reboot :D !"

sleep 3

omarchy-cmd-reboot

echo
echo "Press ENTER to close..."
read
